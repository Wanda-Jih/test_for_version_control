name: Deploy Lambdas (diff-based)

on:
  pull_request:
    types: [closed]
    branches: [main]
    paths:
      - version.json

permissions:
  contents: read

jobs:
  plan:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Extract version.json (before & after)
        run: |
          if git show ${{ github.event.pull_request.base.sha }}:version.json > before.json 2>/dev/null; then
            echo "Found version.json in base commit"
          else
            echo "version.json not found in base commit — treating as empty"
            echo '{}' > before.json
          fi
      
          git show ${{ github.event.pull_request.merge_commit_sha }}:version.json > after.json

      - name: Compute deploy plan
        run: |
          echo "==== Lambda Deploy Plan ===="
      
          jq -n \
            --slurpfile before before.json \
            --slurpfile after after.json '
            reduce ($after[0] | keys[]) as $env ([]; 
              (
                if ($before[0][$env].base // null) != ($after[0][$env].base // null) then
                  . + [{
                    env: $env,
                    type: "base"
                  }]
                else
                  .
                end
              ) +
              (
                reduce (
                  ($after[0][$env].extra // {} | keys_unsorted[])
                ) as $lambda ([]; 
                  if ($before[0][$env].extra[$lambda] // null)
                     != ($after[0][$env].extra[$lambda] // null)
                  then . + [{
                    env: $env,
                    type: "lambda",
                    lambda: $lambda,
                    version: $after[0][$env].extra[$lambda]
                  }]
                  else .
                  end
                )
              )
            )
            ' | jq -r '
              if length == 0 then
                "No lambda deployments required."
              else
                .[] |
                if .type == "base" then
                  "- env: \(.env)\n  - base changed → deploy ALL lambdas"
                else
                  "- env: \(.env)\n  - lambda: \(.lambda) (version: \(.version))"
                end
              '
